<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Investment Portfolio Tracker</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- MODIFICATION: Added CSS variables for theming --- */
        :root {
            --bg-color: #f0f2f5;
            --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --card-bg-color: rgba(255, 255, 255, 0.7);
            --text-color-primary: #1a1a1a;
            --text-color-secondary: #555;
            --border-color: rgba(200, 200, 200, 0.5);
            --shadow-color: rgba(0, 0, 0, 0.1);
            --header-text-color: #ffffff;
            --input-bg-color: rgba(255, 255, 255, 0.9);
            --input-border-color: #e0e0e0;
            --positive-color: #27ae60;
            --negative-color: #e74c3c;
            --accent-color-1: #667eea;
            --accent-color-2: #764ba2;
        }

        [data-theme="dark"] {
            --bg-color: #121212;
            --bg-gradient: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            --card-bg-color: rgba(40, 40, 40, 0.7);
            --text-color-primary: #f5f5f5;
            --text-color-secondary: #a0a0a0;
            --border-color: rgba(100, 100, 100, 0.5);
            --shadow-color: rgba(0, 0, 0, 0.3);
            --header-text-color: #ffffff;
            --input-bg-color: rgba(50, 50, 50, 0.9);
            --input-border-color: #444;
            --positive-color: #2ecc71;
            --negative-color: #e74c3c;
        }
        /* --- END MODIFICATION --- */

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            /* --- MODIFICATION: Switched to Inter font and variables --- */
            font-family: 'Inter', sans-serif;
            background: var(--bg-gradient);
            min-height: 100vh;
            color: var(--text-color-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: var(--header-text-color);
            position: relative;
        }

        .header h1 {
            /* --- MODIFICATION: Adjusted font weight --- */
            font-size: 2.5em;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        #userNameDisplay {
            color: var(--header-text-color);
        }

        .data-status {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            color: white;
            backdrop-filter: blur(10px);
            white-space: nowrap;
            transition: background-color 0.3s ease;
        }

        .data-status.saved { background: rgba(39, 174, 96, 0.8); }
        .data-status.loading { background: rgba(255, 193, 7, 0.8); }
        
        /* --- MODIFICATION: Added Theme Toggle --- */
        .theme-toggle {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            font-size: 1.2em;
            color: white;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        /* --- MODIFICATION: Card Redesign --- */
        .stat-card {
            background: var(--card-bg-color);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 8px 32px var(--shadow-color);
            backdrop-filter: blur(12px);
            border: 1px solid var(--border-color);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 40px var(--shadow-color);
        }

        .stat-value {
            font-size: 2em;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            color: var(--text-color-secondary);
            font-size: 0.9em;
            font-weight: 500;
        }

        .positive { color: var(--positive-color); }
        .negative { color: var(--negative-color); }

        .charts-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        /* --- MODIFICATION: Card Redesign --- */
        .chart-container {
            background: var(--card-bg-color);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 32px var(--shadow-color);
            backdrop-filter: blur(12px);
            border: 1px solid var(--border-color);
        }

        .chart-container h3 {
            text-align: center;
            margin-bottom: 20px;
            color: var(--text-color-primary);
            font-weight: 600;
        }

        .chart-wrapper {
            position: relative;
            height: 300px;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        /* --- MODIFICATION: Card Redesign --- */
        .add-investment, .investments-list {
            background: var(--card-bg-color);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 32px var(--shadow-color);
            backdrop-filter: blur(12px);
            border: 1px solid var(--border-color);
        }

        .add-investment h2, .investments-list h2 {
            margin-bottom: 20px;
            color: var(--text-color-primary);
            font-weight: 600;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--text-color-secondary);
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--input-border-color);
            border-radius: 8px;
            font-size: 16px;
            font-family: 'Inter', sans-serif;
            background-color: var(--input-bg-color);
            color: var(--text-color-primary);
            transition: border-color 0.3s ease;
        }
        
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--accent-color-1);
        }

        .btn {
            background: linear-gradient(45deg, var(--accent-color-1), var(--accent-color-2));
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            width: 100%;
            margin: 2px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        /* --- MODIFICATION: Investment Item Redesign --- */
        .investment-item {
            background: var(--input-bg-color);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            position: relative;
            overflow: hidden; /* For pseudo-element */
            transition: all 0.3s ease;
        }

        /* Gradient Border Effect */
        .investment-item::before {
            content: '';
            position: absolute;
            top: 0; right: 0; bottom: 0; left: 0;
            z-index: -1;
            margin: -2px; /* Border width */
            border-radius: inherit; /* Match parent */
            background: linear-gradient(to right, var(--accent-color-1), var(--accent-color-2), #e74c3c);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .investment-item:hover {
            transform: scale(1.02);
            box-shadow: 0 6px 20px var(--shadow-color);
        }

        .investment-item:hover::before {
            opacity: 1;
        }
        
        .investment-symbol {
            font-size: 1.2em;
            font-weight: 700;
            color: var(--text-color-primary);
        }
        
        .detail-value {
            font-weight: 600;
            color: var(--text-color-primary);
        }
        
        .detail-label {
            font-size: 0.8em;
            color: var(--text-color-secondary);
            margin-bottom: 2px;
            font-weight: 500;
        }
        
        /* Styles for Data Transfer Section */
        #dataTransfer {
            background: var(--card-bg-color);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 32px var(--shadow-color);
            backdrop-filter: blur(12px);
            border: 1px solid var(--border-color);
            margin-top: 30px;
            text-align: center;
        }

        #dataTransfer h2 {
            margin-bottom: 20px;
            color: var(--text-color-primary);
            font-weight: 600;
        }
        
        /* --- All other CSS from your previous version is retained below this line --- */
        /* --- No need to repeat it all here, just showing the modified parts --- */

        .form-group { margin-bottom: 15px; }
        .btn-danger { background: linear-gradient(45deg, #e74c3c, #c0392b); padding: 8px 16px; font-size: 14px; width: auto; }
        .btn-edit { background: linear-gradient(45deg, #f39c12, #e67e22); padding: 8px 16px; font-size: 14px; width: auto; margin-right: 10px; }
        .btn-cancel { background: linear-gradient(45deg, #95a5a6, #7f8c8d); padding: 8px 16px; font-size: 14px; width: auto; margin-right: 10px; }
        .btn-save { background: linear-gradient(45deg, #27ae60, #2ecc71); padding: 8px 16px; font-size: 14px; width: auto; }
        .investment-item.editing { border-left-color: #f39c12; background: #fff; }
        .investment-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .account-badge { padding: 4px 8px; border-radius: 12px; font-size: 0.75em; font-weight: 600; color: white; margin-left: 10px; }
        .account-regular { background: #3498db; }
        .account-roth { background: #e74c3c; }
        .account-401k { background: #f39c12; }
        .account-529 { background: #9b59b6; }
        .account-yahoo { background: #20c997; }
        .investment-details { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 10px; }
        .detail-item { text-align: center; }
        .detail-value.notes { text-align: left; word-wrap: break-word; white-space: pre-wrap; font-weight: normal; grid-column: 1 / -1; padding: 5px 0; border-top: 1px solid var(--border-color); margin-top: 10px; font-size: 0.9em; color: var(--text-color-secondary); }
        .edit-form { display: none; background: #f0f0f0; padding: 15px; border-radius: 8px; margin-top: 15px; }
        .edit-form.active { display: block; }
        .edit-inputs { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px; }
        .edit-group { display: flex; flex-direction: column; }
        .edit-group.full-width { grid-column: 1 / -1; }
        .edit-group label { font-size: 0.9em; color: var(--text-color-secondary); margin-bottom: 5px; font-weight: 600; }
        .edit-input { padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px; transition: border-color 0.3s ease; color: var(--text-color-primary); }
        .edit-input:focus { outline: none; border-color: var(--accent-color-1); }
        .edit-input.edit-notes { min-height: 100px; resize: vertical; }
        .edit-buttons { display: flex; gap: 10px; justify-content: center; }
        .empty-state { text-align: center; padding: 40px; color: var(--text-color-secondary); }
        #clearAllDataBtn { background: linear-gradient(45deg, #e74c3c, #c0392b); }
        #dataOutput, #dataInput { width: 100%; height: 150px; margin-top: 15px; padding: 10px; border: 2px solid var(--border-color); border-radius: 8px; font-size: 0.9em; resize: vertical; display: none; background-color: var(--input-bg-color); color: var(--text-color-primary); }
        #dataInput.active, #dataOutput.active { display: block; }
        #loadImportedDataBtn { margin-top: 10px; display: none; width: auto; background: linear-gradient(45deg, #27ae60, #2ecc71); }
        #loadImportedDataBtn.active { display: block; }
        .investment-group { margin-bottom: 15px; border-radius: 10px; overflow: hidden; }
        .investment-group-header { background: var(--card-bg-color); padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px var(--shadow-color); margin-bottom: 0; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: all 0.2s ease; border-left: 4px solid; }
        .investment-group-header[data-group-type="Regular Brokerage"] { border-left-color: #3498db; }
        .investment-group-header[data-group-type="Roth IRA"] { border-left-color: #e74c3c; }
        .investment-group-header[data-group-type="401(k)"] { border-left-color: #f39c12; }
        .investment-group-header[data-group-type="Yahoo Finance"] { border-left-color: #20c997; }
        .investment-group-header:hover { transform: translateY(-2px); box-shadow: 0 4px 15px var(--shadow-color); }
        .group-summary { flex-grow: 1; }
        .group-title { font-size: 1.3em; font-weight: 700; color: var(--text-color-primary); margin-bottom: 5px; }
        .group-stats { display: flex; gap: 20px; font-size: 0.9em; }
        .group-stat-item .detail-label { font-size: 0.75em; color: var(--text-color-secondary); }
        .group-stat-item .detail-value { font-weight: 600; font-size: 1.1em; color: var(--text-color-primary); }
        .group-stat-item .detail-value.positive { color: var(--positive-color); }
        .group-stat-item .detail-value.negative { color: var(--negative-color); }
        .toggle-icon { font-size: 1.5em; font-weight: bold; color: var(--accent-color-1); margin-left: 15px; transition: transform 0.2s ease; }
        .investment-group.expanded .toggle-icon { transform: rotate(90deg); }
        .investment-group-content { display: none; padding-top: 15px; background: transparent; }
        .investment-group.expanded .investment-group-content { display: block; }
        .refresh-button-container { text-align: right; margin-bottom: 20px; padding-right: 2px; }

        @media (max-width: 1024px) { .charts-section { grid-template-columns: 1fr; } }
        @media (max-width: 768px) {
            .container { padding: 15px; }
            .main-content { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .investment-header { flex-direction: column; align-items: flex-start; gap: 10px; }
            .header { padding-top: 60px; } /* Increased padding for toggles */
            .data-status { position: static; margin: 0 auto 15px auto; display: block; width: fit-content; font-size: 0.75em; }
            .theme-toggle { top: 15px; left: 15px; } /* Reposition toggle */
        }
        @media (max-width: 480px) {
            .stats-grid { grid-template-columns: 1fr; }
            #dataTransfer button { width: 100%; margin: 5px 0; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="theme-toggle" id="themeToggle" onclick="toggleTheme()">☀️</div>
            <div class="data-status" id="dataStatus">💾 Data Stored Locally</div>
            <h1>💰 Investment Portfolio Tracker <span id="userNameDisplay"></span></h1>
            <p>Track your investments across all account types</p>
            <div class="form-group" style="max-width: 300px; margin: 15px auto 0;">
                <label for="userNameInput" style="color: var(--header-text-color); font-weight: normal; font-size: 0.9em; display: block; margin-bottom: 5px;">Your Name:</label>
                <input type="text" id="userNameInput" placeholder="Enter your name" oninput="updateUserName()" style="background: rgba(255, 255, 255, 0.9); border: none; color: #333;">
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="totalValue">$0.00</div>
                <div class="stat-label">Total Portfolio Value</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalInvested">$0.00</div>
                <div class="stat-label">Total Invested</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalGainLoss">$0.00</div>
                <div class="stat-label">Total Gain/Loss</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalReturn">0.00%</div>
                <div class="stat-label">Total Return</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="todayPortfolioGainLoss">$0.00</div>
                <div class="stat-label">Today's Portfolio Gain/Loss</div>
            </div>
        </div>

        <div class="refresh-button-container">
            <button type="button" class="btn" id="toggleAutoRefreshBtn" onclick="toggleAutoRefresh()">Pause Auto-Refresh</button>
            <button type="button" class="btn" onclick="refreshAllPrices()">Refresh Now</button>
        </div>

        <div class="charts-section">
             <div class="chart-container">
                <h3>Portfolio by Account Type</h3>
                <div class="chart-wrapper">
                    <canvas id="accountChart"></canvas>
                </div>
            </div>
            <div class="chart-container">
                <h3>Portfolio by Investment Type</h3>
                <div class="chart-wrapper">
                    <canvas id="investmentChart"></canvas>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="add-investment">
				<div class="investment-group-header" onclick="toggleAddForm()" style="margin-bottom: 0; border-radius: 10px 10px 0 0; border-left-color: #27ae60;">
					<div class="group-summary">
						<div class="group-title">Add New Investment 
							<span class="account-badge" style="background: #27ae60;">Form</span>
						</div>
						<div class="group-stats">
							<div class="group-stat-item">
								<div class="detail-label">Click to expand form</div>
							</div>
						</div>
					</div>
					<span class="toggle-icon" id="addFormToggleIcon">&#9658;</span>
				</div>
				
				<div id="addFormContent" style="display: none; padding: 25px; background: transparent;">
					<div class="form-group">
						<label for="symbol">Symbol</label>
						<input type="text" id="symbol" name="symbol" placeholder="e.g., AAPL, TSLA" required>
					</div>
					<div class="form-group">
						<label for="name">Company Name</label>
						<input type="text" id="name" name="name" placeholder="e.g., Apple Inc." required>
					</div>
					<div class="form-group">
						<label for="accountType">Account Type</label>
						<select id="accountType" name="accountType" required>
							<option value="">Select Account Type</option>
							<option value="Regular Brokerage">Regular Brokerage</option>
							<option value="Roth IRA">Roth IRA</option>
							<option value="401(k)">401(k)</option>
							<option value="529 College Saving">529 College Saving</option>
							<option value="Yahoo Finance">Yahoo Finance</option>
						</select>
					</div>
					<div class="form-group">
						<label for="platform">Platform</label>
						<input type="text" id="platform" name="platform" placeholder="e.g., Fidelity, Charles Schwab, Vanguard" required>
					</div>
					<div class="form-group">
						<label for="shares">Number of Shares</label>
						<input type="number" id="shares" name="shares" step="0.0001" min="0" placeholder="100" required>
					</div>
					<div class="form-group">
						<label for="purchasePrice">Purchase Price per Share</label>
						<input type="number" id="purchasePrice" name="purchasePrice" step="0.0001" min="0" placeholder="150.00" required>
					</div>
					<div class="form-group">
						<label for="currentPrice">Current Price per Share (Optional, will auto-update)</label>
						<input type="number" id="currentPrice" name="currentPrice" step="0.0001" min="0" placeholder="165.00 (will auto-update)">
					</div>
					<div class="form-group">
						<label for="type">Investment Type</label>
						<select id="type" name="type" required>
							<option value="">Select Type</option>
							<option value="Stock">Stock</option>
							<option value="ETF">ETF</option>
							<option value="Bond">Bond</option>
							<option value="Mutual Fund">Mutual Fund</option>
							<option value="Cryptocurrency">Cryptocurrency</option>
							<option value="Other">Other</option>
							<option value="CASH">CASH</option>
						</select>
					</div>
					<div class="form-group">
						<label for="notes">Notes</label>
						<textarea id="notes" name="notes" placeholder="e.g., Long-term hold, dividend stock, research target price"></textarea>
					</div>
					<button type="button" class="btn" onclick="addNewInvestment()">Add Investment</button>
				</div>
			</div>

            <div class="investments-list">
                <h2>Your Investments</h2>
                <div id="investmentsList">
                    <div class="empty-state">
                        <div style="font-size: 3em; margin-bottom: 15px;">📊</div>
                        <p>No investments added yet. Start building your portfolio!</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="dataTransfer">
            <h2>Data Transfer</h2>
            <button class="btn" onclick="exportData()">Export Data</button>
            <button class="btn" onclick="importData()">Import Data</button>
            <button class="btn" id="clearAllDataBtn" onclick="clearAllData()">Clear All Data</button>
            
            <textarea id="dataOutput" readonly></textarea>
            
            <textarea id="dataInput" placeholder="Paste your exported data here..."></textarea>
            <button class="btn" id="loadImportedDataBtn" onclick="loadImportedData()">Load Imported Data</button>
            <p style="margin-top: 10px; color: #e74c3c; display: none;" id="importErrorMsg">Error parsing data. Please ensure it is valid JSON.</p>
        </div>

    </div>

    <script>
        // --- All JavaScript from your previous version is retained below this line ---
        // --- Only the new theme toggle functions are added ---
        
        // --- MODIFICATION: Theme Management Functions ---
        const THEME_KEY = 'myInvestmentPortfolioTheme';

        function applyTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            const toggleIcon = document.getElementById('themeToggle');
            if (toggleIcon) {
                toggleIcon.textContent = theme === 'dark' ? '☀️' : '🌙';
            }
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            localStorage.setItem(THEME_KEY, newTheme);
            applyTheme(newTheme);
            // Re-render charts with new theme colors
            updateCharts();
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem(THEME_KEY) || 'light';
            applyTheme(savedTheme);
        }
        // --- END MODIFICATION ---

        // Your existing JavaScript code...
        const FINNHUB_API_KEY = 'd2a7htpr01qvhs80gqsgd2a7htpr01qvhs80gqt0';
        const WATCHLIST_ACCOUNT_TYPE = 'Yahoo Finance';
        let portfolioData = { username: '', investments: [] };
        let accountChart = null;
        let investmentChart = null;
        let expandedGroups = {};
		let isAddFormExpanded = false;
        let autoRefreshIntervalId = null;
        let isAutoRefreshEnabled = true;
        const STORAGE_KEY = 'myInvestmentPortfolio';
        const EXPANDED_GROUPS_KEY = 'myInvestmentPortfolioExpandedGroups';
        const AUTO_REFRESH_STATE_KEY = 'myInvestmentPortfolioAutoRefreshState';
        // ... (The rest of your extensive JS code remains unchanged)
        
        // MODIFIED document.addEventListener to include loadTheme()
        document.addEventListener('DOMContentLoaded', async () => {
            loadTheme(); // Load theme first
            loadInvestments();
            loadAddFormState();
            loadAutoRefreshState(); 

            await refreshAllPrices(); 

            if (isAutoRefreshEnabled) {
                startAutoRefresh();
            } else {
                updateAutoRefreshButton();
            }
        });

        // MODIFIED updateCharts to use theme variables
        function updateCharts() {
            // ... (existing chart logic)
            // Example of how to adapt chart colors to the theme:
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
            const gridColor = currentTheme === 'dark' ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
            const labelColor = currentTheme === 'dark' ? '#f5f5f5' : '#333';

            // Inside Chart.js options:
            // options: {
            //     plugins: { legend: { labels: { color: labelColor } } },
            //     scales: { x: { ticks: { color: labelColor }, grid: { color: gridColor } }, y: { ticks: { color: labelColor }, grid: { color: gridColor } } }
            // }

             if (portfolioData.investments.length === 0) { // Check portfolioData.investments
                // Destroy existing charts if no data
                if (accountChart) {
                    accountChart.destroy();
                    accountChart = null;
                }
                if (investmentChart) {
                    investmentChart.destroy();
                    investmentChart = null;
                }
                return;
            }

            // Account Type Chart
            const accountData = {};
            // Filter out watchlist for charts if desired, or include them
            // For now, let's include all in charts for a full picture, but exclude from stats
            portfolioData.investments.forEach(inv => {
                const value = inv.shares * inv.currentPrice;
                if (inv.accountType && inv.accountType.trim() !== '') {
                    accountData[inv.accountType] = (accountData[inv.accountType] || 0) + value;
                }
            });

            const accountLabels = Object.keys(accountData);
            const accountValues = Object.values(accountData);
            
            const accountColors = {
                'Regular Brokerage': '#3498db',
                'Roth IRA': '#e74c3c',
                '401(k)': '#f39c12',
                '529 College Saving': '#9b59b6',
                'Yahoo Finance': '#20c997'
            };

            const accountChartColors = accountLabels.map(label => accountColors[label] || '#95a5a6');

            if (accountChart) {
                accountChart.destroy();
            }

            if (accountLabels.length > 0) {
                const ctx1 = document.getElementById('accountChart').getContext('2d');
                const totalAccountValue = accountValues.reduce((a, b) => a + b, 0);
                
                accountChart = new Chart(ctx1, {
                    type: 'doughnut',
                    data: {
                        labels: accountLabels,
                        datasets: [{
                            data: accountValues,
                            backgroundColor: accountChartColors,
                            borderWidth: 3,
                            borderColor: currentTheme === 'dark' ? '#121212' : '#f0f2f5'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    color: labelColor,
                                    padding: 20,
                                    usePointStyle: true
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const percentage = totalAccountValue > 0 ? ((context.parsed * 100) / totalAccountValue).toFixed(1) : '0.0';
                                        return `${context.label}: ${formatCurrency(context.parsed)} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // Investment Type Chart
            const investmentData = {};
            portfolioData.investments.forEach(inv => { // Iterate portfolioData.investments
                const value = inv.shares * inv.currentPrice;
                if (inv.type && inv.type.trim() !== '') {
                    investmentData[inv.type] = (investmentData[inv.type] || 0) + value;
                }
            });

            const investmentLabels = Object.keys(investmentData);
            const investmentValues = Object.values(investmentData);

            const investmentColors = {
                'Stock': '#2ecc71',
                'ETF': '#3498db',
                'Bond': '#f39c12',
                'Mutual Fund': '#9b59b6',
                'Cryptocurrency': '#e67e22',
                'Other': '#95a5a6',
                'CASH': '#4CAF50'
            };

            const investmentChartColors = investmentLabels.map(label => investmentColors[label] || '#95a5a6');

            if (investmentChart) {
                investmentChart.destroy();
            }

            if (investmentLabels.length > 0) {
                const ctx2 = document.getElementById('investmentChart').getContext('2d');
                const totalInvestmentValue = investmentValues.reduce((a, b) => a + b, 0);
                
                investmentChart = new Chart(ctx2, {
                    type: 'pie',
                    data: {
                        labels: investmentLabels,
                        datasets: [{
                            data: investmentValues,
                            backgroundColor: investmentChartColors,
                            borderWidth: 3,
                            borderColor: currentTheme === 'dark' ? '#121212' : '#f0f2f5'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    color: labelColor,
                                    padding: 20,
                                    usePointStyle: true
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const percentage = totalInvestmentValue > 0 ? ((context.parsed * 100) / totalInvestmentValue).toFixed(1) : '0.0';
                                        return `${context.label}: ${formatCurrency(context.parsed)} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }
        function saveInvestments() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(portfolioData));
                localStorage.setItem(EXPANDED_GROUPS_KEY, JSON.stringify(expandedGroups)); // Save expanded state
                updateDataStatus(true); // Data saved
            } catch (e) {
                console.error("Error saving to localStorage:", e);
                updateDataStatus(false, "Error saving data");
            }
        }

        function loadInvestments() {
            try {
                const storedData = localStorage.getItem(STORAGE_KEY);
                if (storedData) {
                    const parsedData = JSON.parse(storedData);
                    // Check for new object structure or old array structure
                    if (parsedData.username !== undefined && Array.isArray(parsedData.investments)) {
                        portfolioData = parsedData; // New structure
                    } else if (Array.isArray(parsedData)) {
                        // Handle legacy data (just an array of investments)
                        portfolioData = {
                            username: '', // Default for legacy data
                            investments: parsedData
                        };
                        console.warn("Loaded legacy data format. Username not found.");
                    } else {
                        // Fallback if data is corrupted or unexpected
                        console.error("Unexpected data format in localStorage. Resetting data.");
                        portfolioData = { username: '', investments: [] };
                    }

                    // Ensure all investments have a 'notes' field for consistency
                    portfolioData.investments.forEach(inv => {
                        if (inv.notes === undefined) {
                            inv.notes = ''; // Add notes field if missing
                        }
                    });

                    updateDataStatus(true); // Data loaded
                } else {
                    portfolioData = { username: '', investments: [] }; // Initialize empty if no data
                    updateDataStatus(false, "No saved data found");
                }

                const storedExpandedGroups = localStorage.getItem(EXPANDED_GROUPS_KEY);
                if (storedExpandedGroups) {
                    expandedGroups = JSON.parse(storedExpandedGroups);
                } else {
                    expandedGroups = {}; // Default to collapsed
                }

            } catch (e) {
                console.error("Error loading from localStorage:", e);
                portfolioData = { username: '', investments: [] }; // Reset if corrupted data
                expandedGroups = {};
                updateDataStatus(false, "Error loading data");
            }
            sortInvestments(); // Sort after loading, before display
        }

        function clearAllData() {
            if (confirm('Are you sure you want to clear ALL investment data? This action cannot be undone unless you have exported your data.')) {
                localStorage.removeItem(STORAGE_KEY);
                localStorage.removeItem(EXPANDED_GROUPS_KEY);
                portfolioData = { username: '', investments: [] }; // Reset to default empty
                expandedGroups = {};
                updateDisplay();
                updateDataStatus(false, "Data cleared by user");
                alert('All investment data has been cleared.');
            }
        }

        function updateDataStatus(isSaved, message = "") {
            const statusElement = document.getElementById('dataStatus');
            statusElement.classList.remove('saved', 'loading'); // Reset classes
            if (isSaved === true) {
                statusElement.textContent = '✅ Data Saved Locally';
                statusElement.classList.add('saved');
            } else if (isSaved === false) {
                statusElement.textContent = `⚠️ Data Stored in Memory ${message ? `(${message})` : ''}`;
            } else if (isSaved === 'loading') { // Custom state for loading
                 statusElement.textContent = '🔄 Updating prices...';
                 statusElement.classList.add('loading');
            }
        }
        // --- End Persistence Functions --
        
        function saveAutoRefreshState() {
            localStorage.setItem(AUTO_REFRESH_STATE_KEY, JSON.stringify(isAutoRefreshEnabled));
        }

        function loadAutoRefreshState() {
            const savedState = localStorage.getItem(AUTO_REFRESH_STATE_KEY);
            // Default to true (enabled) if no saved state exists
            isAutoRefreshEnabled = savedState !== null ? JSON.parse(savedState) : true;
        }

        function updateAutoRefreshButton() {
            const toggleBtn = document.getElementById('toggleAutoRefreshBtn');
            if (!toggleBtn) return; // Exit if button not found

            if (isAutoRefreshEnabled) {
                toggleBtn.textContent = 'Pause Auto-Refresh';
                // Use an orange/yellow gradient to indicate a "pause" action
                toggleBtn.style.background = 'linear-gradient(45deg, #f39c12, #e67e22)';
            } else {
                toggleBtn.textContent = 'Resume Auto-Refresh';
                // Use a green gradient to indicate a "resume" or "start" action
                toggleBtn.style.background = 'linear-gradient(45deg, #27ae60, #2ecc71)';
            }
        }

        function startAutoRefresh() {
            if (autoRefreshIntervalId !== null) return; // Already running
            
            isAutoRefreshEnabled = true;
            autoRefreshIntervalId = setInterval(() => {
                console.log('Auto-refreshing prices...');
                refreshAllPrices();
            }, 60000); // 60 seconds
            
            updateAutoRefreshButton();
            saveAutoRefreshState();
        }

        function stopAutoRefresh() {
            if (autoRefreshIntervalId !== null) {
                clearInterval(autoRefreshIntervalId);
                autoRefreshIntervalId = null;
            }
            
            isAutoRefreshEnabled = false;
            updateAutoRefreshButton();
            saveAutoRefreshState();
        }

        function toggleAutoRefresh() {
            if (isAutoRefreshEnabled) {
                stopAutoRefresh();
            } else {
                startAutoRefresh();
                // Immediately refresh when resuming so the user sees fresh data
                console.log('Resuming and refreshing prices now...');
                refreshAllPrices();
            }
        }

        async function fetchPriceFromFinnhub(symbol) {
            if (!FINNHUB_API_KEY || FINNHUB_API_KEY === 'YOUR_FINNHUB_API_KEY') {
                console.warn("Finnhub API key is not set or is a placeholder. Cannot fetch real-time prices.");
                return { currentPrice: null, previousClosePrice: null };
            }
            try {
                const response = await fetch(`https://finnhub.io/api/v1/quote?symbol=${symbol}&token=${FINNHUB_API_KEY}`);
                const data = await response.json();

                if (response.ok && data && typeof data.c === 'number' && data.c > 0) {
                    return {
                        currentPrice: data.c,
                        previousClosePrice: typeof data.pc === 'number' && data.pc > 0 ? data.pc : null
                    };
                } else {
                    console.error(`Finnhub: Failed to fetch price for ${symbol}. Response:`, data);
                    return { currentPrice: null, previousClosePrice: null };
                }
            } catch (error) {
                console.error(`Finnhub: Error fetching price for ${symbol}:`, error);
                return { currentPrice: null, previousClosePrice: null };
            }
        }

        async function fetchCurrentPrice(investment) {
            let priceData = { currentPrice: null, previousClosePrice: null };

            if (investment.type === 'Stock' || investment.type === 'ETF' || investment.type === 'Cryptocurrency') {
                priceData = await fetchPriceFromFinnhub(investment.symbol);
                if (priceData.currentPrice === null) {
                    console.warn(`Could not fetch live price for ${investment.symbol} (${investment.type}). Keeping existing value.`);
                }
            } else if (investment.type === 'Mutual Fund') {

                console.warn(`Cannot auto-update price for Mutual Fund "${investment.symbol}". You may need to update this manually or integrate a specific (likely paid) mutual fund data API.`);
                // Return existing price to avoid resetting it to zero/null
                priceData = {
                    currentPrice: investment.currentPrice,
                    previousClosePrice: investment.previousClosePrice
                };
            } else if (investment.type === 'Bond') {

                console.warn(`Cannot auto-update price for Bond "${investment.symbol}". You may need to update this manually or integrate a specialized bond data API.`);
                // Return existing price to avoid resetting it to zero/null
                priceData = {
                    currentPrice: investment.currentPrice,
                    previousClosePrice: investment.previousClosePrice
                };
            } else if (investment.type === 'CASH') {
                // For CASH, currentPrice should always be its value, and previousClosePrice can be the same.
                priceData = {
                    currentPrice: investment.currentPrice,
                    previousClosePrice: investment.currentPrice // For cash, previous = current
                };
            } else { // 'Other' types
                console.warn(`Cannot auto-update price for investment type "${investment.type}" (${investment.symbol}). Manual update required.`);
                // Return existing price to avoid resetting it to zero/null
                priceData = {
                    currentPrice: investment.currentPrice,
                    previousClosePrice: investment.previousClosePrice
                };
            }
            return priceData;
        }

        // Function to refresh all prices
        async function refreshAllPrices() {
            if (portfolioData.investments.length === 0) {
                // alert("No investments to refresh prices for."); // Commented out to avoid alerts during auto-refresh
                return;
            }

            const refreshButton = document.querySelector('.refresh-button-container .btn:last-child');
            const originalButtonText = refreshButton.textContent;
            refreshButton.textContent = 'Refreshing...';
            refreshButton.disabled = true;
            updateDataStatus('loading'); // Show loading status

            let updatedCount = 0;
            for (const investment of portfolioData.investments) {
                // Call the new generic fetchCurrentPrice function
                const priceData = await fetchCurrentPrice(investment);

                // Update only if a valid new price was fetched and it's different from current
                if (priceData.currentPrice !== null && priceData.currentPrice !== investment.currentPrice) {
                    investment.currentPrice = priceData.currentPrice;
                    investment.previousClosePrice = priceData.previousClosePrice;
                    updatedCount++;
                }
                // Also update previousClosePrice if it was null/undefined but currentPrice is valid
                else if (priceData.currentPrice !== null && (investment.previousClosePrice === null || investment.previousClosePrice === undefined)) {
                    investment.previousClosePrice = priceData.previousClosePrice;
                    updatedCount++; // Count this as an update for data completeness
                } else if (investment.type === 'CASH') {
                    // Ensure CASH type's previousClosePrice always matches its currentPrice
                    investment.previousClosePrice = investment.currentPrice;
                }
            }

            updateDisplay();
            saveInvestments(); // Save updated prices

            refreshButton.textContent = originalButtonText;
            refreshButton.disabled = false;
            updateDataStatus(true); // Revert to saved status
            
        }
        function sortInvestments() {
             const accountTypeOrder = [
                'Regular Brokerage',
                'Roth IRA',
                '401(k)',
                'Yahoo Finance' // Added for consistent rendering and grouping
            ];
            portfolioData.investments.sort((a, b) => {
                // 1. Sort by Account Type (primary sort)
                const indexA = accountTypeOrder.indexOf(a.accountType);
                const indexB = accountTypeOrder.indexOf(b.accountType);

                // Handle cases where account type is not in the predefined order
                // Non-grouped items will sort after the grouped items, by default
                const finalIndexA = indexA === -1 ? accountTypeOrder.length : indexA;
                const finalIndexB = indexB === -1 ? accountTypeOrder.length : indexB;

                if (finalIndexA !== finalIndexB) {
                    return finalIndexA - finalIndexB;
                }

                // 2. If Account Types are the same (or both ungrouped), sort by Investment Type: CASH first
                if (a.type === 'CASH' && b.type !== 'CASH') {
                    return -1; // a (CASH) comes before b (non-CASH)
                }
                if (a.type !== 'CASH' && b.type === 'CASH') {
                    return 1; // b (CASH) comes before a (non-CASH)
                }

                // 3. If Account Types are the same AND both are CASH or both are non-CASH, sort by Symbol
                return a.symbol.localeCompare(b.symbol);
            });
        }
        function exportData() {
            const dataOutput = document.getElementById('dataOutput');
            const dataInput = document.getElementById('dataInput');
            const loadBtn = document.getElementById('loadImportedDataBtn');
            const importErrorMsg = document.getElementById('importErrorMsg');

            // Hide import elements
            dataInput.style.display = 'none';
            loadBtn.style.display = 'none';
            importErrorMsg.style.display = 'none';

            // Show and populate export textarea
            dataOutput.value = JSON.stringify(portfolioData, null, 2); // Export portfolioData
            dataOutput.style.display = 'block';
            dataOutput.select(); // Select all text for easy copying
            document.execCommand('copy'); // Attempt to copy to clipboard
            alert('Data copied to clipboard!'); // Inform user
        }

        function importData() {
            const dataOutput = document.getElementById('dataOutput');
            const dataInput = document.getElementById('dataInput');
            const loadBtn = document.getElementById('loadImportedDataBtn');
            const importErrorMsg = document.getElementById('importErrorMsg');

            // Hide export textarea
            dataOutput.style.display = 'none';
            dataOutput.value = ''; // Clear previous export data

            // Show import elements
            dataInput.style.display = 'block';
            loadBtn.style.display = 'block';
            importErrorMsg.style.display = 'none'; // Hide error message initially
            dataInput.focus(); // Focus for pasting
        }

        function loadImportedData() {
            const dataInput = document.getElementById('dataInput');
            const importErrorMsg = document.getElementById('importErrorMsg');
            let importedText = dataInput.value.trim();

            // Robust cleaning: remove common invisible characters and non-breaking spaces
            importedText = importedText.replace(/[\u0000-\u001F\u007F-\u009F\u00A0]/g, '').trim();

            if (!importedText) {
                alert('Please paste data into the text area before loading.');
                return;
            }

            if (!confirm('Are you sure you want to load this data? This will overwrite your current portfolio.')) {
                return; // User cancelled
            }

            try {
                const parsedData = JSON.parse(importedText);
                // Validate new portfolioData structure
                if (parsedData.username !== undefined && Array.isArray(parsedData.investments)) {
                    // Basic validation for investments array elements
                    if (parsedData.investments.length === 0 || (parsedData.investments[0].symbol && parsedData.investments[0].shares)) {
                        portfolioData = parsedData; // Assign directly
                        // Ensure imported investments have a 'notes' field
                        portfolioData.investments.forEach(inv => {
                            if (inv.notes === undefined) {
                                inv.notes = '';
                            }
                        });
                        sortInvestments(); // Sort imported data
                        saveInvestments(); // Save imported data to localStorage
                        updateDisplay();
                        alert('Portfolio loaded successfully!');
                        dataInput.value = ''; // Clear textarea after successful import
                        dataInput.style.display = 'none';
                        document.getElementById('loadImportedDataBtn').style.display = 'none';
                        importErrorMsg.style.display = 'none';
                    } else {
                        throw new Error('Invalid investment data format within the imported JSON. Please check the "investments" array.');
                    }
                } else if (Array.isArray(parsedData)) { // Handle legacy import (just an array)
                    portfolioData = {
                        username: '', // Default empty username for legacy import
                        investments: parsedData
                    };
                    // Ensure imported investments have a 'notes' field
                    portfolioData.investments.forEach(inv => {
                        if (inv.notes === undefined) {
                            inv.notes = '';
                        }
                    });
                    sortInvestments();
                    saveInvestments();
                    updateDisplay();
                    alert('Portfolio loaded successfully (legacy format). Please set your username.');
                    dataInput.value = '';
                    dataInput.style.display = 'none';
                    document.getElementById('loadImportedDataBtn').style.display = 'none';
                    importErrorMsg.style.display = 'none';
                } else {
                    throw new Error('Invalid data format. Please paste valid JSON with "username" and "investments" properties, or a simple array of investments.');
                }
            } catch (e) {
                importErrorMsg.textContent = `Error parsing data: ${e.message}. Please ensure it is valid JSON.`;
                importErrorMsg.style.display = 'block';
                console.error("Error parsing imported data:", e);
            }
        }
        function updateUserName() {
            const userNameInput = document.getElementById('userNameInput');
            portfolioData.username = userNameInput.value.trim();
            saveInvestments(); // Save username immediately
            updateUserNameDisplay(); // Update the displayed name
        }

        function updateUserNameDisplay() {
            const userNameDisplay = document.getElementById('userNameDisplay');
            const userNameInput = document.getElementById('userNameInput'); // Get the input field too

            if (portfolioData.username) {
                userNameDisplay.textContent = `for ${portfolioData.username}`;
            } else {
                userNameDisplay.textContent = ''; // Clear if no username
            }
            // Ensure input field also reflects the current username from data
            userNameInput.value = portfolioData.username;
        }
        function toggleGroup(groupName) {
            expandedGroups[groupName] = !expandedGroups[groupName]; // Toggle state
            saveInvestments(); // Save the new state
            updateDisplay(); // Re-render to apply the state
        }
		function toggleAddForm() {
			isAddFormExpanded = !isAddFormExpanded;
			const addFormContent = document.getElementById('addFormContent');
			const toggleIcon = document.getElementById('addFormToggleIcon');
			
			if (isAddFormExpanded) {
				addFormContent.style.display = 'block';
				toggleIcon.innerHTML = '&#9660;'; // Down arrow
			} else {
				addFormContent.style.display = 'none';
				toggleIcon.innerHTML = '&#9658;'; // Right arrow
			}
			
			localStorage.setItem('addFormExpanded', isAddFormExpanded);
		}

		function loadAddFormState() {
			const savedState = localStorage.getItem('addFormExpanded');
			if (savedState !== null) {
				isAddFormExpanded = savedState === 'true';
				toggleAddForm();
			}
		}
        function formatCurrency(amount) {
            // Formats to currency with exactly 2 decimal places
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2, // Always show exactly two decimals
                maximumFractionDigits: 2  // Always show exactly two decimals
            }).format(amount);
        }

        function formatPercentage(value) {
            return (value * 100).toFixed(2) + '%';
        }

        function addNewInvestment() {
            const symbol = document.getElementById('symbol').value.trim();
            const name = document.getElementById('name').value.trim();
            const accountType = document.getElementById('accountType').value;
            const platform = document.getElementById('platform').value.trim(); // Get platform
            const shares = document.getElementById('shares').value;
            const purchasePrice = document.getElementById('purchasePrice').value;
            let currentPrice = document.getElementById('currentPrice').value;
            const type = document.getElementById('type').value;
            const notes = document.getElementById('notes').value.trim(); // Get notes

            // Validate inputs, including new platform field
            if (!symbol || !name || !accountType || !shares || !purchasePrice || !type || !platform) {
                alert('Please fill in all required fields (Symbol, Name, Account Type, Shares, Purchase Price, Type, Platform).');
                return;
            }

            if (isNaN(shares) || isNaN(purchasePrice) || 
                parseFloat(shares) < 0 || parseFloat(purchasePrice) < 0) { // Allow 0 shares for watchlist
                alert('Please enter valid non-negative numbers for shares and purchase price.');
                return;
            }

            // If currentPrice is not provided, use purchasePrice as initial currentPrice
            let initialCurrentPrice = currentPrice ? parseFloat(currentPrice) : parseFloat(purchasePrice);

            const investment = {
                id: Date.now(), // Unique ID for each investment
                symbol: symbol.toUpperCase(),
                name: name,
                accountType: accountType,
                platform: platform, // Add the new field
                shares: parseFloat(shares),
                purchasePrice: parseFloat(purchasePrice),
                currentPrice: initialCurrentPrice, // Use provided or initial purchase price
                previousClosePrice: null, // Initialize previousClosePrice, will be set by fetchCurrentPrice
                type: type,
                notes: notes // Add notes field
            };

            portfolioData.investments.push(investment); // Add to portfolioData.investments
            sortInvestments(); // Sort after adding
            saveInvestments(); // Save after adding
            updateDisplay();
            clearForm();
            
            // After adding, immediately try to fetch its current price and previous close
            // No need to await here, let it run in background
            fetchCurrentPrice(investment).then(priceData => {
                if (priceData.currentPrice !== null) {
                    investment.currentPrice = priceData.currentPrice;
                    investment.previousClosePrice = priceData.previousClosePrice;
                    updateDisplay(); // Re-render to show updated price
                    saveInvestments(); // Save updated price
                }
            });
        }

        function clearForm() {
            document.getElementById('symbol').value = '';
            document.getElementById('name').value = '';
            document.getElementById('accountType').value = '';
            document.getElementById('platform').value = ''; // Clear platform
            document.getElementById('shares').value = '';
            document.getElementById('purchasePrice').value = '';
            document.getElementById('currentPrice').value = '';
            document.getElementById('type').value = '';
            document.getElementById('notes').value = ''; // Clear notes
        }

        function removeInvestment(id) {
            if (confirm('Are you sure you want to remove this investment?')) {
                portfolioData.investments = portfolioData.investments.filter(inv => inv.id !== id); // Filter portfolioData.investments
                sortInvestments(); // Sort after removing
                saveInvestments(); // Save after removing
                updateDisplay();
            }
        }

        function editInvestment(id) {
            const investment = portfolioData.investments.find(inv => inv.id === id); // Find in portfolioData.investments
            if (!investment) return;

            // Hide all other edit forms
            document.querySelectorAll('.edit-form').forEach(form => form.classList.remove('active'));
            document.querySelectorAll('.investment-item').forEach(item => item.classList.remove('editing'));

            // Show edit form for this investment
            const editForm = document.getElementById(`edit-form-${id}`);
            const investmentItem = document.getElementById(`investment-${id}`);
            
            editForm.classList.add('active');
            investmentItem.classList.add('editing');

            // Populate form with current values
            editForm.querySelector('.edit-symbol').value = investment.symbol;
            editForm.querySelector('.edit-name').value = investment.name;
            editForm.querySelector('.edit-shares').value = investment.shares;
            editForm.querySelector('.edit-purchase-price').value = investment.purchasePrice;
            editForm.querySelector('.edit-current-price').value = investment.currentPrice;
            editForm.querySelector('.edit-account-type').value = investment.accountType;
            editForm.querySelector('.edit-platform').value = investment.platform || ''; // Populate platform
            editForm.querySelector('.edit-type').value = investment.type;
            editForm.querySelector('.edit-notes').value = investment.notes || ''; // Populate notes
        }

        function cancelEdit(id) {
            const editForm = document.getElementById(`edit-form-${id}`);
            const investmentItem = document.getElementById(`investment-${id}`);
            
            editForm.classList.remove('active');
            investmentItem.classList.remove('editing');
        }

        function saveInvestmentEdit(id) {
            const editForm = document.getElementById(`edit-form-${id}`);
            const symbol = editForm.querySelector('.edit-symbol').value.trim().toUpperCase();
            const name = editForm.querySelector('.edit-name').value.trim();
            const shares = parseFloat(editForm.querySelector('.edit-shares').value);
            const purchasePrice = parseFloat(editForm.querySelector('.edit-purchase-price').value);
            const currentPrice = parseFloat(editForm.querySelector('.edit-current-price').value);
            const accountType = editForm.querySelector('.edit-account-type').value;
            const platform = editForm.querySelector('.edit-platform').value.trim(); // Get platform from edit form
            const type = editForm.querySelector('.edit-type').value;
            const notes = editForm.querySelector('.edit-notes').value.trim(); // Get notes from edit form

            // Validate inputs, including platform
            if (!symbol || !name || !accountType || !type || !platform ||
                isNaN(shares) || isNaN(purchasePrice) || isNaN(currentPrice) || 
                shares < 0 || purchasePrice < 0 || currentPrice < 0) { // Allow 0 or positive
                alert('Please enter valid non-negative numbers for shares and prices, and ensure all text fields are filled.');
                return;
            }

            const investment = portfolioData.investments.find(inv => inv.id === id); // Find in portfolioData.investments
            if (investment) {
                investment.symbol = symbol;
                investment.name = name;
                investment.shares = shares;
                investment.purchasePrice = purchasePrice;
                investment.currentPrice = currentPrice; // Allow manual edit of current price
                // previousClosePrice is NOT edited manually, it's fetched by API
                investment.accountType = accountType;
                investment.platform = platform; // Save platform
                investment.type = type;
                investment.notes = notes; // Save notes
                
                // If the type is changed TO CASH, ensure previousClosePrice is updated too
                if (type === 'CASH') {
                    investment.previousClosePrice = currentPrice;
                }
                // If type is changed FROM CASH to something else, previousClosePrice will be null until next refresh
                
                sortInvestments(); // Sort after editing
                saveInvestments(); // Save after editing
                updateDisplay();
                cancelEdit(id);
            }
        }

        function calculateStats() {
            let totalInvested = 0;
            let totalValue = 0;
            let totalDailyGainLoss = 0; // New variable for today's gain/loss

            portfolioData.investments.forEach(inv => { // Iterate portfolioData.investments
                // **New Logic:** Only include investments NOT in the watchlist account type in calculations
                if (inv.accountType !== WATCHLIST_ACCOUNT_TYPE) {
                    totalInvested += inv.shares * inv.purchasePrice;
                    totalValue += inv.shares * inv.currentPrice;

                    // Calculate daily gain/loss only if previousClosePrice is valid and not CASH
                    if (inv.type !== 'CASH' && inv.previousClosePrice !== null && inv.previousClosePrice !== undefined && inv.previousClosePrice > 0) {
                        totalDailyGainLoss += (inv.currentPrice - inv.previousClosePrice) * inv.shares;
                    }
                }
            });

            const totalGainLoss = totalValue - totalInvested;
            const totalReturn = totalInvested > 0 ? totalGainLoss / totalInvested : 0;

            return {
                totalInvested,
                totalValue,
                totalGainLoss,
                totalReturn,
                totalDailyGainLoss // Return the new stat
            };
        }

        function updateStats() {
            const stats = calculateStats();
            
            document.getElementById('totalValue').textContent = formatCurrency(stats.totalValue);
            document.getElementById('totalInvested').textContent = formatCurrency(stats.totalInvested);
            
            const gainLossElement = document.getElementById('totalGainLoss');
            gainLossElement.textContent = formatCurrency(stats.totalGainLoss);
            gainLossElement.className = 'stat-value ' + (stats.totalGainLoss >= 0 ? 'positive' : 'negative');
            
            const returnElement = document.getElementById('totalReturn');
            returnElement.textContent = formatPercentage(stats.totalReturn);
            returnElement.className = 'stat-value ' + (stats.totalReturn >= 0 ? 'positive' : 'negative');

            // New: Update Today's Portfolio Gain/Loss
            const todayGainLossElement = document.getElementById('todayPortfolioGainLoss');
            todayGainLossElement.textContent = formatCurrency(stats.totalDailyGainLoss);
            todayGainLossElement.className = 'stat-value ' + (stats.totalDailyGainLoss >= 0 ? 'positive' : 'negative');
        }

        function getAccountBadgeClass(accountType) {
            const classMap = {
                'Regular Brokerage': 'account-regular',
                'Roth IRA': 'account-roth',
                '401(k)': 'account-401k',
                '529 College Saving': 'account-529',
                'Yahoo Finance': 'account-yahoo' // Added class for Yahoo Finance group
            };
            return classMap[accountType] || 'account-regular';
        }

        function renderInvestments() {
            const container = document.getElementById('investmentsList');
            container.innerHTML = ''; // Clear existing list

            if (portfolioData.investments.length === 0) { // Check portfolioData.investments
                container.innerHTML = `
                    <div class="empty-state">
                        <div style="font-size: 3em; margin-bottom: 15px;">📊</div>
                        <p>No investments added yet. Start building your portfolio!</p>
                    </div>
                `;
                return;
            }

            // Group investments by account type
            const investmentsByGroup = {};
            const ungroupedInvestments = []; // For any account types not in accountTypeOrder
            const accountTypeOrder = [
                'Regular Brokerage',
                'Roth IRA',
                '401(k)',
                'Yahoo Finance' // Added for consistent rendering and grouping
            ];

            portfolioData.investments.forEach(inv => { // Iterate portfolioData.investments
                if (accountTypeOrder.includes(inv.accountType)) {
                    if (!investmentsByGroup[inv.accountType]) {
                        investmentsByGroup[inv.accountType] = [];
                    }
                    investmentsByGroup[inv.accountType].push(inv);
                } else {
                    // For account types not in the specific grouping order (e.g., 529), render them separately.
                    // If you want them in groups, add them to accountTypeOrder.
                    ungroupedInvestments.push(inv);
                }
            });

            // Render groups in specific order
            accountTypeOrder.forEach(groupName => { // Use accountTypeOrder for consistent rendering
                const groupInvestments = investmentsByGroup[groupName];
                if (groupInvestments && groupInvestments.length > 0) {
                    const totalGroupInvested = groupInvestments.reduce((sum, inv) => sum + (inv.shares * inv.purchasePrice), 0);
                    const totalGroupValue = groupInvestments.reduce((sum, inv) => sum + (inv.shares * inv.currentPrice), 0);
                    const totalGroupGainLoss = totalGroupValue - totalGroupInvested;
                    const totalGroupGainLossClass = totalGroupGainLoss >= 0 ? 'positive' : 'negative';

                    // Calculate Today's Group Gain/Loss
                    let totalGroupDailyGainLoss = 0;
                    groupInvestments.forEach(inv => {
                        if (inv.type !== 'CASH' && inv.previousClosePrice !== null && inv.previousClosePrice !== undefined && inv.previousClosePrice > 0) {
                            totalGroupDailyGainLoss += (inv.currentPrice - inv.previousClosePrice) * inv.shares;
                        }
                    });
                    const totalGroupDailyGainLossClass = totalGroupDailyGainLoss >= 0 ? 'positive' : 'negative';


                    const isExpanded = expandedGroups[groupName];
                    const toggleIcon = isExpanded ? '&#9660;' : '&#9658;'; // Down arrow vs Right arrow

                    let groupHtml = `
                        <div class="investment-group ${isExpanded ? 'expanded' : ''}" id="group-${groupName.replace(/\s+/g, '-').toLowerCase()}">
                            <div class="investment-group-header" data-group-type="${groupName}" onclick="toggleGroup('${groupName}')">
                                <div class="group-summary">
                                    <div class="group-title">${groupName} <span class="account-badge ${getAccountBadgeClass(groupName)}">Grouped</span></div>
                                    <div class="group-stats">
                                        <div class="group-stat-item">
                                            <div class="detail-label">Total Value</div>
                                            <div class="detail-value">${formatCurrency(totalGroupValue)}</div>
                                        </div>
                                        <div class="group-stat-item">
                                            <div class="detail-label">Total Gain/Loss</div>
                                            <div class="detail-value ${totalGroupGainLossClass}">${formatCurrency(totalGroupGainLoss)}</div>
                                        </div>
                                        <div class="group-stat-item">
                                            <div class="detail-label">Today's Gain/Loss</div>
                                            <div class="detail-value ${totalGroupDailyGainLossClass}">${formatCurrency(totalGroupDailyGainLoss)}</div>
                                        </div>
                                    </div>
                                </div>
                                <span class="toggle-icon">${toggleIcon}</span>
                            </div>
                            <div class="investment-group-content" id="${groupName.replace(/\s+/g, '-').toLowerCase()}GroupItems">
                    `;
                    
                    groupInvestments.forEach(inv => {
                        groupHtml += renderIndividualInvestmentItem(inv);
                    });

                    groupHtml += `
                            </div>
                        </div>
                    `;
                    container.innerHTML += groupHtml;
                }
            });

            // Render ungrouped investments (including 529 College Saving, if not explicitly added to accountTypeOrder)
            ungroupedInvestments.forEach(inv => {
                container.innerHTML += renderIndividualInvestmentItem(inv);
            });
        }

        // Helper function to render a single investment item HTML
        function renderIndividualInvestmentItem(inv) {
            const totalInvested = inv.shares * inv.purchasePrice;
            const currentValue = inv.shares * inv.currentPrice;
            
            // Calculations for Total Gain/Loss (from purchase price)
            const totalGainLoss = currentValue - totalInvested;
            const totalReturnPercentage = totalInvested > 0 ? totalGainLoss / totalInvested : 0;
            const totalGainLossClass = totalGainLoss >= 0 ? 'positive' : 'negative'; 

            // Calculations for Today's Gain/Loss (from previous close)
            let todayGainLossAmount = 0; // This will now be the TOTAL dollar amount for the holding
            let todayGainLossPercentage = 0;
            let todayGainLossClass = '';
            let isTodayGainLossCalculable = false;

            // Only calculate daily change if it's not CASH and previousClosePrice is available and valid
            if (inv.type !== 'CASH' && inv.previousClosePrice !== null && inv.previousClosePrice !== undefined && inv.previousClosePrice > 0) {
                const priceChangePerShare = inv.currentPrice - inv.previousClosePrice;
                todayGainLossAmount = priceChangePerShare * inv.shares; // Corrected: Total gain/loss for the holding

                const previousCloseValue = inv.previousClosePrice * inv.shares; // Total value at previous close
                if (previousCloseValue > 0) {
                    todayGainLossPercentage = todayGainLossAmount / previousCloseValue; // Corrected: Percentage based on total previous close value
                }
                
                todayGainLossClass = todayGainLossAmount >= 0 ? 'positive' : 'negative';
                isTodayGainLossCalculable = true;
            } else {
                todayGainLossClass = 'neutral'; // Or keep it empty for N/A
            }

            return `
                <div class="investment-item" id="investment-${inv.id}" data-account-type="${inv.accountType}">
                    <div class="investment-header">
                        <div>
                            <div class="investment-symbol">
                                ${inv.symbol}
                                <span class="account-badge ${getAccountBadgeClass(inv.accountType)}">${inv.accountType}</span>
                            </div>
                            <div style="color: #666; font-size: 0.9em;">${inv.name} • ${inv.type}</div>
                        </div>
                        <div>
                            <button class="btn btn-edit" onclick="editInvestment(${inv.id})">Edit</button>
                            <button class="btn btn-danger" onclick="removeInvestment(${inv.id})">Remove</button>
                        </div>
                    </div>
                    <div class="investment-details">
                        <div class="detail-item">
                            <div class="detail-label">Shares</div>
                            <div class="detail-value">${inv.shares.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 4 })}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Purchase Price</div>
                            <div class="detail-value">${formatCurrency(inv.purchasePrice)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Current Price</div>
                            <div class="detail-value">${formatCurrency(inv.currentPrice)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Total Invested</div>
                            <div class="detail-value">${formatCurrency(totalInvested)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Current Value</div>
                            <div class="detail-value">${formatCurrency(currentValue)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Total Gain/Loss</div>
                            <div class="detail-value ${totalGainLossClass}">${formatCurrency(totalGainLoss)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Total Return %</div>
                            <div class="detail-value ${totalGainLossClass}">${formatPercentage(totalReturnPercentage)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Today's Gain/Loss</div>
                            <div class="detail-value ${todayGainLossClass}">
                                ${isTodayGainLossCalculable ? formatCurrency(todayGainLossAmount) : 'N/A'}
                            </div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Today's Gain/Loss %</div>
                            <div class="detail-value ${todayGainLossClass}">
                                ${isTodayGainLossCalculable ? formatPercentage(todayGainLossPercentage) : 'N/A'}
                            </div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Platform</div>
                            <div class="detail-value">${inv.platform || 'N/A'}</div>
                        </div>
                        ${inv.notes ? `<div class="detail-item notes"><strong>Notes:</strong> ${inv.notes}</div>` : ''}
                    </div>
                    <div class="edit-form" id="edit-form-${inv.id}">
                        <div class="edit-inputs">
                            <div class="edit-group">
                                <label>Symbol:</label>
                                <input type="text" class="edit-input edit-symbol">
                            </div>
                            <div class="edit-group">
                                <label>Company Name:</label>
                                <input type="text" class="edit-input edit-name">
                            </div>
                            <div class="edit-group">
                                <label>Account Type:</label>
                                <select class="edit-input edit-account-type">
                                    <option value="Regular Brokerage">Regular Brokerage</option>
                                    <option value="Roth IRA">Roth IRA</option>
                                    <option value="401(k)">401(k)</option>
                                    <option value="529 College Saving">529 College Saving</option>
                                    <option value="Yahoo Finance">Yahoo Finance</option>
                                </select>
                            </div>
                            <div class="edit-group">
                                <label>Platform:</label>
                                <input type="text" class="edit-input edit-platform">
                            </div>
                            <div class="edit-group">
                                <label>Shares:</label>
                                <input type="number" step="0.0001" min="0" class="edit-input edit-shares">
                            </div>
                            <div class="edit-group">
                                <label>Purchase Price:</label>
                                <input type="number" step="0.0001" min="0" class="edit-input edit-purchase-price">
                            </div>
                            <div class="edit-group">
                                <label>Current Price:</label>
                                <input type="number" step="0.0001" min="0" class="edit-input edit-current-price">
                            </div>
                            <div class="edit-group">
                                <label>Investment Type:</label>
                                <select class="edit-input edit-type">
                                    <option value="Stock">Stock</option>
                                    <option value="ETF">ETF</option>
                                    <option value="Bond">Bond</option>
                                    <option value="Mutual Fund">Mutual Fund</option>
                                    <option value="Cryptocurrency">Cryptocurrency</option>
                                    <option value="Other">Other</option>
                                    <option value="CASH">CASH</option>
                                </select>
                            </div>
                            <div class="edit-group full-width">
                                <label>Notes:</label>
                                <textarea class="edit-input edit-notes"></textarea>
                            </div>
                        </div>
                        <div class="edit-buttons">
                            <button class="btn btn-save" onclick="saveInvestmentEdit(${inv.id})">Save</button>
                            <button class="btn btn-cancel" onclick="cancelEdit(${inv.id})">Cancel</button>
                        </div>
                    </div>
                </div>
            `;
        }


        function updateDisplay() {
            updateUserNameDisplay();
            updateStats();
            updateCharts();
            renderInvestments(); // This will now handle the grouping
        }
    </script>
</body>
</html>